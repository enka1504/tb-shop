{% comment %} 
  Main collection with Grid/List toggle 
{% endcomment %}

{{ 'collection-toggle.css' | asset_url | stylesheet_tag }}
<script src="{{ 'collection-toggle.js' | asset_url }}" defer></script>
{{ 'fantastic-overlays.css' | asset_url | stylesheet_tag }}
<script src="{{ 'fantastic-overlays.js' | asset_url }}" defer></script>

{% render 'collection-filter-drawer' %}
{% render 'collection-quick-view-modal' %}

{%- liquid
  assign products_per_page = section.settings.products_per_page
  assign layout_default = section.settings.default_view
-%}

{{ 'cart-drawer.css' | asset_url | stylesheet_tag }}
<script src="{{ 'cart-drawer.js' | asset_url }}" defer="defer"></script>
{% render 'cart-drawer' %}
<div
  class="ct-collection"
  data-collection-toggle
  data-default-view="{{ layout_default }}">
  <div class="ct-toolbar">
    <div class="ct-toolbar__left">
      {%- if section.settings.show_filter_button -%}
        <button
          type="button"
          class="ct-btn ct-btn--ghost ct-filter-btn"
          data-open-filters>
          <span class="ct-icon" aria-hidden="true">‚éò</span>
          <span>Filter</span>
        </button>
      {%- endif -%}

      <div class="ct-count">
        {%- if collection.products_count == 1 -%}
          1 product
        {%- else -%}
          {{ collection.products_count }} products
        {%- endif -%}
      </div>
    </div>

    <div class="ct-toolbar__right">
      {%- if section.settings.show_sort -%}
        <div class="ct-sort">
          <label class="ct-sort__label" for="SortBy">Sort by:</label>
          <select
            id="SortBy"
            class="ct-sort__select"
            name="sort_by"
            data-sort-by>
            {%- for option in collection.sort_options -%}
              <option
                value="{{ option.value }}"
                {% if option.value == collection.sort_by %}
                selected{% endif %}>
                {{ option.name }}
              </option>
            {%- endfor -%}
          </select>
        </div>
      {%- endif -%}

      <div class="ct-view">
        <button
          type="button"
          class="ct-view__btn"
          aria-label="List view"
          aria-pressed="false"
          data-view-btn="list">
          <!-- list icon -->
          <svg
            width="18"
            height="18"
            viewBox="0 0 18 18"
            aria-hidden="true">
            <rect
              x="2"
              y="3"
              width="3"
              height="3"
              rx="0.6"></rect>
            <rect
              x="7"
              y="3.6"
              width="9"
              height="1.8"
              rx="0.9"></rect>
            <rect
              x="2"
              y="7.5"
              width="3"
              height="3"
              rx="0.6"></rect>
            <rect
              x="7"
              y="8.1"
              width="9"
              height="1.8"
              rx="0.9"></rect>
            <rect
              x="2"
              y="12"
              width="3"
              height="3"
              rx="0.6"></rect>
            <rect
              x="7"
              y="12.6"
              width="9"
              height="1.8"
              rx="0.9"></rect>
          </svg>
        </button>

        <button
          type="button"
          class="ct-view__btn"
          aria-label="Grid view"
          aria-pressed="true"
          data-view-btn="grid">
          <!-- grid icon -->
          <svg
            width="18"
            height="18"
            viewBox="0 0 18 18"
            aria-hidden="true">
            <rect
              x="2"
              y="2"
              width="6"
              height="6"
              rx="1"></rect>
            <rect
              x="10"
              y="2"
              width="6"
              height="6"
              rx="1"></rect>
            <rect
              x="2"
              y="10"
              width="6"
              height="6"
              rx="1"></rect>
            <rect
              x="10"
              y="10"
              width="6"
              height="6"
              rx="1"></rect>
          </svg>
        </button>
      </div>
    </div>
  </div>

  {%- paginate collection.products by products_per_page -%}

    <div class="ct-products" data-products-container>
      {%- for product in collection.products -%}
        <article
          class="ct-card"
          data-product-card
          data-product-handle="{{ product.handle }}">
          <a class="ct-card__media" href="{{ product.url }}">
            {%- if product.featured_image -%}
              {{ product.featured_image | image_url: width: 900 | image_tag: loading: 'lazy', class: 'ct-card__img', alt: product.title }}
            {%- else -%}
              <div class="ct-card__img ct-card__img--placeholder"></div>
            {%- endif -%}

            {%- if product.available == false -%}
              <span class="ct-badge ct-badge--muted">Sold out</span>
            {%- endif -%}

            {%- if product.tags contains 'Highly rated' -%}
              <span class="ct-badge ct-badge--purple">Highly rated</span>
            {%- endif -%}

            {%- if product.tags contains 'Best Buy' -%}
              <span class="ct-badge ct-badge--red">Best Buy</span>
            {%- endif -%}

            {%- if product.tags contains 'Deal' -%}
              <span class="ct-badge ct-badge--yellow">Deal</span>
            {%- endif -%}
          </a>

          <div class="ct-card__body">
            {%- if product.vendor != blank -%}
              <div class="ct-card__vendor">{{ product.vendor }}</div>
            {%- endif -%}

            <h3 class="ct-card__title">
              <a href="{{ product.url }}">{{ product.title }}</a>
            </h3>

            {%- if section.settings.show_excerpt -%}
              <div class="ct-card__excerpt">
                {{ product.description | strip_html | truncate: 140 }}
              </div>
            {%- endif -%}

            <div class="ct-card__meta">
              <div class="ct-price">
                {%- if product.price_varies -%}
                  <span class="ct-price__from">From</span>
                {%- endif -%}
                <span class="ct-price__current">{{ product.price | money }}</span>

                {%- if product.compare_at_price_max > product.price -%}
                  <span class="ct-price__compare">{{ product.compare_at_price_max | money }}</span>
                  {%- assign savings = product.compare_at_price_max | minus: product.price -%}
                  {%- assign pct = savings | times: 100.0 | divided_by: product.compare_at_price_max -%}
                  <span class="ct-price__badge">-{{ pct | round }}%</span>
                {%- endif -%}
              </div>

              <div class="ct-stock">
                <span class="ct-dot {% if product.available %}ct-dot--in{% else %}ct-dot--out{% endif %}"></span>
                <span>
                  {% if product.available %}In stock{% else %}Out of stock{% endif %}
                </span>
              </div>
            </div>

            <div class="ct-card__actions">
              <div class="ct-qty" aria-label="Quantity selector">
                <button
                  class="ct-qty__btn"
                  type="button"
                  data-qty-minus
                  aria-label="Decrease quantity">‚àí</button>
                <input
                  class="ct-qty__input"
                  type="number"
                  min="1"
                  value="1"
                  inputmode="numeric"
                  data-qty-input
                  aria-label="Quantity">
                <button
                  class="ct-qty__btn"
                  type="button"
                  data-qty-plus
                  aria-label="Increase quantity">+</button>
              </div>

              {%- if product.available == false -%}
                <button
                  class="ct-btn ct-btn--primary"
                  type="button"
                  disabled>Sold out</button>
              {%- else -%}
                {%- if product.has_only_default_variant -%}
                  <form
                    method="post"
                    action="/cart/add"
                    class="ct-atc">
                    <input
                      type="hidden"
                      name="id"
                      value="{{ product.selected_or_first_available_variant.id }}">
                    <input
                      type="hidden"
                      name="quantity"
                      value="1"
                      data-form-qty>
                    <button type="submit" class="ct-btn ct-btn--primary">Add to cart</button>
                  </form>
                {%- else -%}
                  <a class="ct-btn ct-btn--primary" href="{{ product.url }}">Choose option</a>
                {%- endif -%}
              {%- endif -%}

              {%- if section.settings.show_quick_view -%}
                <button
                  type="button"
                  class="ct-btn ct-btn--secondary"
                  data-quick-view
                  data-product-url="{{ product.url }}">Quick view</button>
              {%- endif -%}
            </div>
          </div>
        </article>
      {%- endfor -%}
    </div>

    {%- if paginate.pages > 1 -%}
      <nav
        class="ct-pagination"
        role="navigation"
        aria-label="Pagination">
        {%- if paginate.previous -%}
          <a class="ct-page" href="{{ paginate.previous.url }}">‚Üê</a>
        {%- else -%}
          <span class="ct-page ct-page--disabled">‚Üê</span>
        {%- endif -%}

        {%- for part in paginate.parts -%}
          {%- if part.is_link -%}
            <a class="ct-page" href="{{ part.url }}">{{ part.title }}</a>
          {%- else -%}
            <span class="ct-page {% if part.title == paginate.current_page %}ct-page--active{% endif %}">
              {{ part.title }}
            </span>
          {%- endif -%}
        {%- endfor -%}

        {%- if paginate.next -%}
          <a class="ct-page" href="{{ paginate.next.url }}">‚Üí</a>
        {%- else -%}
          <span class="ct-page ct-page--disabled">‚Üí</span>
        {%- endif -%}
      </nav>
    {%- endif -%}

  {%- endpaginate -%}
</div>
<!-- Related Collections Section -->
<div class="related-collections">
  <h2 class="related-collections__title">Related collections</h2>

  <div class="related-collections__list">
    {%- for collection in collections -%}
      <div class="related-collections__item">
        <a href="{{ collection.url }}" class="related-collections__link">
          <img
            src="{{ collection.image | img_url: 'medium' }}"
            alt="{{ collection.title }}"
            class="related-collections__image"
            width="100%"
            height="200px" />
          <div class="related-collections__details">
            <span class="related-collections__name">{{ collection.title }}</span>
            <span class="related-collections__item-count">{{ collection.products_count }} items</span>
          </div>
        </a>
      </div>
    {%- endfor -%}
  </div>
</div>

<!-- Promotional Banner Section -->
<div class="promotional-banner">
  <div class="promotional-banner__content">
    <p class="promotional-banner__title">More than groceries, at your door from 1 hour!</p>
    <p class="promotional-banner__description">Free delivery on your first order over $500.</p>
    <div class="promotional-banner__features">
      <div class="feature-item">
        <span class="feature-icon">‚öñÔ∏è</span>
        <p>Quality at fair prices</p>
      </div>
      <div class="feature-item">
        <span class="feature-icon">üòä</span>
        <p>100% satisfaction</p>
      </div>
      <div class="feature-item">
        <span class="feature-icon">ü•á</span>
        <p>Best online food shop</p>
      </div>
    </div>
  </div>
  <div class="promotional-banner__image">
    {% if section.blocks.settings.mini_img_1 != blank %}
      {{ section.block.settings.mini_img_1 | image_url: width: 120 | image_tag: class: 'hvMini__img', loading: 'lazy' }}
    {% endif %}
  </div>
</div>
<style>
  /* Related Collections Section */
  .related-collections {
    margin: 40px 0;
    padding: 20px;
  }

  .related-collections__title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 20px;
    text-align: center;
  }

  .related-collections__list {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
  }

  .related-collections__item {
    width: calc(15% - 16px);
    text-align: center;
  }

  .related-collections__link {
    display: block;
    text-decoration: none;
  }

  .related-collections__image {
    width: 100%;
    height: 200px;
    border-radius: 8px;
  }

  .related-collections__details {
    margin-top: 10px;
  }

  .related-collections__name {
    font-weight: 600;
    font-size: 18px;
  }

  .related-collections__item-count {
    font-size: 14px;
    color: #64748b;
  }

  /* Promotional Banner Section */
  .promotional-banner {
    background-color: #0b4a7d;
    color: white;
    padding: 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 8px;
    margin: 0 20px;
  }

  .promotional-banner__content {
    max-width: 600px;
    margin-right: 20px;
  }

  .promotional-banner__title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 16px;
  }

  .promotional-banner__description {
    font-size: 16px;
    margin-bottom: 20px;
  }

  .promotional-banner__features {
    display: flex;
    gap: 20px;
  }

  .feature-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
  }

  .feature-icon {
    font-size: 20px;
  }

  .promotional-banner__image img {
    max-width: 400px;
    width: 100%;
    border-radius: 8px;
  }

  /* Responsive Styles */
  @media (max-width: 768px) {
    .related-collections__item {
      width: calc(50% - 16px);
    }

    .promotional-banner {
      flex-direction: column;
      align-items: flex-start;
    }

    .promotional-banner__content {
      margin-right: 0;
    }

    .promotional-banner__image img {
      max-width: 100%;
      margin-top: 20px;
    }
  }

  @media (max-width: 480px) {
    .related-collections__item {
      width: 100%;
    }
  }

</style>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Update a card's hidden form quantity from its visible qty input
    const syncQtyToForm = (card) => {
      if (!card) return;
      const qtyInput = card.querySelector('[data-qty-input]');
      const formQty = card.querySelector('form.ct-atc [data-form-qty]');
      if (!qtyInput || !formQty) return;
  
      const q = Math.max(1, parseInt(qtyInput.value || '1', 10));
      qtyInput.value = String(q);
      formQty.value = String(q);
    };
  
    // Plus / minus buttons
    document.addEventListener('click', (e) => {
      const card = e.target.closest('[data-product-card]');
      if (!card) return;
  
      const qtyInput = card.querySelector('[data-qty-input]');
      if (!qtyInput) return;
  
      if (e.target.matches('[data-qty-plus]')) {
        e.preventDefault();
        qtyInput.value = String((parseInt(qtyInput.value || '1', 10) || 1) + 1);
        syncQtyToForm(card);
      }
  
      if (e.target.matches('[data-qty-minus]')) {
        e.preventDefault();
        const next = (parseInt(qtyInput.value || '1', 10) || 1) - 1;
        qtyInput.value = String(Math.max(1, next));
        syncQtyToForm(card);
      }
    });
  
    // Typing directly into qty input
    document.addEventListener('input', (e) => {
      if (!e.target.matches('[data-qty-input]')) return;
      const card = e.target.closest('[data-product-card]');
      syncQtyToForm(card);
    });
  
    // Before submit, ensure the hidden quantity matches (important)
    document.addEventListener('submit', (e) => {
      const form = e.target;
      if (!form || !form.matches('form.ct-atc[action*="/cart/add"]')) return;
      const card = form.closest('[data-product-card]');
      syncQtyToForm(card);
    });
  });
</script>
{% schema %}
  {
    "name": "Main collection",
    "settings": [
      {
        "type": "range",
        "id": "products_per_page",
        "min": 8,
        "max": 48,
        "step": 4,
        "default": 12,
        "label": "Products per page"
      },
      {
        "type": "select",
        "id": "default_view",
        "label": "Default view",
        "default": "grid",
        "options": [
          {
            "value": "grid",
            "label": "Grid"
          }, {
            "value": "list",
            "label": "List"
          }
        ]
      },
      {
        "type": "checkbox",
        "id": "show_sort",
        "default": true,
        "label": "Show sort dropdown"
      },
      {
        "type": "checkbox",
        "id": "show_filter_button",
        "default": true,
        "label": "Show filter button (UI only)"
      }, {
        "type": "checkbox",
        "id": "show_excerpt",
        "default": true,
        "label": "Show description excerpt (list looks better with this)"
      }, {
        "type": "checkbox",
        "id": "show_quick_view",
        "default": true,
        "label": "Show quick view button (UI only)"
      }, {
        "type": "image_picker",
        "id": "mini_img_1",
        "label": "Mini 1 image"
      }
    ],
    "blocks": [
      {
        "type": "bundle",
        "name": "Bundle tile",
        "settings": [
          {
            "type": "image_picker",
            "id": "mini_img_1",
            "label": "Mini 1 image"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Main collection",
        "blocks": [
          {
            "type": "bundle"
          }
        ]
      }
    ]
  }
{% endschema %}
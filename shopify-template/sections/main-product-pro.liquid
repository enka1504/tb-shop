{% comment %}
  Professional Product Page (Pro+)
  Features:
  - Swipe gallery (mobile) + zoom (click/tap)
  - Variant availability disabling (chips greyed-out)
  - Upsells/cross-sells via Product Recommendations API
  - Bundles (multi-add) + optional automatic discount (requires a Discount configured)
  - Sticky ATC (desktop + mobile)
  - Klaviyo hooks
  - Metafields: size guide, materials, specs
{% endcomment %}

{{ 'section-main-product-pro.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign v = product.selected_or_first_available_variant
  assign size_guide = product.metafields.custom.size_guide
  assign materials  = product.metafields.custom.materials
  assign specs      = product.metafields.custom.specs
-%}

<section class="pp" data-section-id="{{ section.id }}"
  data-product-handle="{{ product.handle }}"
  data-product-id="{{ product.id }}"
  data-product-title="{{ product.title | escape }}"
  data-product-url="{{ product.url }}"
  data-product-price="{{ v.price }}"
>
  <div class="pp__wrap page-width">
    <div class="pp__grid">
      <!-- MEDIA -->
      <div class="pp__media">
        {% if product.media.size > 0 %}
          <div class="pp__gallery" data-gallery>
            <div class="pp__main" data-main>
              <div class="pp__slider" data-slider>
                {% for media in product.media %}
                  {% if media.media_type == 'image' %}
                    <div class="pp__slide" data-media-id="{{ media.id }}">
                      {{ media | image_url: width: 1400 | image_tag: class: 'pp__img', loading: 'eager', alt: product.title }}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>

              <button class="pp__nav pp__nav--prev" type="button" data-prev aria-label="Previous image">‹</button>
              <button class="pp__nav pp__nav--next" type="button" data-next aria-label="Next image">›</button>

              <div class="pp__dots" data-dots aria-label="Gallery pagination"></div>
            </div>

            {% if product.media.size > 1 %}
              <div class="pp__thumbs" aria-label="Product thumbnails">
                {% for media in product.media %}
                  {% if media.media_type == 'image' %}
                    <button class="pp__thumb" type="button" data-thumb="{{ forloop.index0 }}" aria-label="View image {{ forloop.index }}">
                      {{ media | image_url: width: 240 | image_tag: loading: 'lazy', alt: product.title }}
                    </button>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <!-- Zoom Modal -->
          <dialog class="pp__zoom" data-zoom>
            <button class="pp__zoomClose" type="button" data-zoom-close aria-label="Close zoom">✕</button>
            <div class="pp__zoomBody">
              <img class="pp__zoomImg" data-zoom-img alt="{{ product.title | escape }}">
              <div class="pp__zoomHint">Scroll / pinch to zoom</div>
            </div>
          </dialog>
        {% else %}
          <div class="pp__placeholder">No media</div>
        {% endif %}
      </div>

      <!-- INFO -->
      <div class="pp__info">
        {% if section.settings.show_vendor %}
          <div class="pp__vendor">{{ product.vendor }}</div>
        {% endif %}

        <h1 class="pp__title">{{ product.title }}</h1>

        {% if section.settings.show_rating %}
          <div class="pp__rating" role="img" aria-label="Rating">
            ★★★★☆ <span class="pp__ratingText">4.6 (1,248)</span>
          </div>
        {% endif %}

        <!-- PRICE -->
        <div class="pp__price" id="Price-{{ section.id }}">
          <span class="pp__priceNow" data-price-now>{{ v.price | money }}</span>
          <span class="pp__priceWas" data-price-was>
            {% if v.compare_at_price and v.compare_at_price > v.price %}
              {{ v.compare_at_price | money }}
            {% endif %}
          </span>
          <span class="pp__badge" data-price-badge {% unless v.compare_at_price and v.compare_at_price > v.price %}style="display:none"{% endunless %}>
            Save {{ v.compare_at_price | minus: v.price | money }}
          </span>
          <span class="pp__soldout" data-soldout {% if v.available %}style="display:none"{% endif %}>Sold out</span>
        </div>

        {% if section.settings.show_short %}
          <p class="pp__short">
            {{ product.description | strip_html | truncate: 180 }}
          </p>
        {% endif %}

        <!-- FORM -->
        <product-form class="pp__form" data-section="{{ section.id }}">
          {% form 'product', product, id: "product-form-" | append: section.id, novalidate: 'novalidate' %}
            <input type="hidden" name="id" value="{{ v.id }}" data-variant-id>
            <input type="hidden" name="quantity" value="1" data-hidden-qty>

            <!-- VARIANTS -->
            {% unless product.has_only_default_variant %}
              <div class="pp__options" data-options>
                {% for option in product.options_with_values %}
                  <fieldset class="pp__opt" data-option-index="{{ forloop.index0 }}">
                    <legend class="pp__optLabel">{{ option.name }}</legend>
                    <div class="pp__optGrid">
                      {% for value in option.values %}
                        {% assign input_id = section.id | append: '-' | append: option.name | append: '-' | append: value | handle %}
                        <input
                          class="pp__radio"
                          type="radio"
                          name="options[{{ option.name }}]"
                          id="{{ input_id }}"
                          value="{{ value | escape }}"
                          {% if option.selected_value == value %}checked{% endif %}
                          data-option-value="{{ value | escape }}"
                        >
                        <label class="pp__chip" for="{{ input_id }}" data-chip>{{ value }}</label>
                      {% endfor %}
                    </div>
                  </fieldset>
                {% endfor %}
              </div>
            {% endunless %}

            <!-- QUANTITY + BUTTONS -->
            <div class="pp__buyRow">
              <div class="pp__qty">
                <button class="pp__qtyBtn" type="button" data-qty="minus" aria-label="Decrease quantity">−</button>
                <input class="pp__qtyInput" type="number" min="1" value="1" inputmode="numeric" data-qty-input>
                <button class="pp__qtyBtn" type="button" data-qty="plus" aria-label="Increase quantity">+</button>
              </div>

              <button
                type="submit"
                name="add"
                class="pp__atc"
                data-atc
                {% unless v.available %}disabled{% endunless %}
              >
                {% if v.available %}Add to cart{% else %}Sold out{% endif %}
              </button>
            </div>

            {{ form | payment_button }}

            {% if section.settings.show_trust %}
              <ul class="pp__trust" role="list">
                <li>✅ Free shipping over {{ section.settings.free_ship_threshold | money }}</li>
                <li>✅ 30-day returns</li>
                <li>✅ Secure checkout</li>
              </ul>
            {% endif %}
          {% endform %}
        </product-form>

        <!-- BUNDLES / BUY X GET Y -->
        {% if section.settings.enable_bundles %}
          <div class="pp__bundle" data-bundle>
            <div class="pp__bundleHeader">
              <div class="pp__bundleTitle">{{ section.settings.bundle_title }}</div>
              <div class="pp__bundleHint">{{ section.settings.bundle_hint }}</div>
            </div>

            <div class="pp__bundleItems">
              {% if section.settings.bundle_product_1 != blank %}
                {% assign p1 = all_products[section.settings.bundle_product_1] %}
                {% if p1 %}
                  <label class="pp__bundleItem">
                    <input type="checkbox" checked data-bundle-variant="{{ p1.selected_or_first_available_variant.id }}">
                    <span class="pp__bundleName">{{ p1.title }}</span>
                    <span class="pp__bundlePrice">{{ p1.selected_or_first_available_variant.price | money }}</span>
                  </label>
                {% endif %}
              {% endif %}

              {% if section.settings.bundle_product_2 != blank %}
                {% assign p2 = all_products[section.settings.bundle_product_2] %}
                {% if p2 %}
                  <label class="pp__bundleItem">
                    <input type="checkbox" data-bundle-variant="{{ p2.selected_or_first_available_variant.id }}">
                    <span class="pp__bundleName">{{ p2.title }}</span>
                    <span class="pp__bundlePrice">{{ p2.selected_or_first_available_variant.price | money }}</span>
                  </label>
                {% endif %}
              {% endif %}

              {% if section.settings.bundle_product_3 != blank %}
                {% assign p3 = all_products[section.settings.bundle_product_3] %}
                {% if p3 %}
                  <label class="pp__bundleItem">
                    <input type="checkbox" data-bundle-variant="{{ p3.selected_or_first_available_variant.id }}">
                    <span class="pp__bundleName">{{ p3.title }}</span>
                    <span class="pp__bundlePrice">{{ p3.selected_or_first_available_variant.price | money }}</span>
                  </label>
                {% endif %}
              {% endif %}
            </div>

            <div class="pp__bundleActions">
              <button class="pp__bundleBtn" type="button" data-bundle-add>
                Add selected bundle
              </button>

              {% if section.settings.bundle_discount_code != blank %}
                <div class="pp__bundleNote">
                  Discount applied at checkout: <strong>{{ section.settings.bundle_discount_code }}</strong>
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}

        <!-- ACCORDIONS -->
        <div class="pp__acc">
          <details open class="pp__accItem">
            <summary>Description</summary>
            <div class="pp__accBody rte">{{ product.description }}</div>
          </details>

          {% if materials != blank %}
            <details class="pp__accItem">
              <summary>Materials</summary>
              <div class="pp__accBody rte">{{ materials.value }}</div>
            </details>
          {% endif %}

          {% if size_guide != blank %}
            <details class="pp__accItem">
              <summary>Size guide</summary>
              <div class="pp__accBody rte">{{ size_guide.value }}</div>
            </details>
          {% endif %}

          {% if specs != blank %}
            <details class="pp__accItem">
              <summary>Specs</summary>
              <div class="pp__accBody rte">{{ specs.value }}</div>
            </details>
          {% endif %}

          <details class="pp__accItem">
            <summary>Shipping</summary>
            <div class="pp__accBody">
              <p>Ships in 1–2 business days. Tracking included.</p>
              <p>Free shipping over {{ section.settings.free_ship_threshold | money }}.</p>
            </div>
          </details>

          <details class="pp__accItem">
            <summary>Returns</summary>
            <div class="pp__accBody">
              <p>30-day returns. Items must be unworn and in original packaging.</p>
            </div>
          </details>
        </div>

        <!-- UPSELLS / RECOMMENDATIONS -->
        {% if section.settings.enable_recs %}
          <div class="pp__recs" data-recs
            data-recs-url="/recommendations/products?product_id={{ product.id }}&limit={{ section.settings.recs_limit }}&intent=related">
            <div class="pp__recsTitle">{{ section.settings.recs_title }}</div>
            <div class="pp__recsGrid" data-recs-grid>
              <div class="pp__recsSkeleton">Loading recommendations…</div>
            </div>
          </div>
        {% endif %}

        <!-- STICKY ATC (DESKTOP) -->
        <div class="pp__sticky" aria-hidden="true" data-sticky-desktop>
          <div class="pp__stickyInner">
            <div class="pp__stickyTitle">{{ product.title }}</div>
            <div class="pp__stickyPrice" data-sticky-price>{{ v.price | money }}</div>
            <button class="pp__stickyBtn" type="button" data-sticky-atc>Add to cart</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MOBILE STICKY ATC -->
  <div class="pp__mbar" data-sticky-mobile>
    <div class="pp__mbarInner">
      <div class="pp__mbarLeft">
        <div class="pp__mbarTitle">{{ product.title }}</div>
        <div class="pp__mbarPrice" data-mbar-price>{{ v.price | money }}</div>
      </div>
      <button class="pp__mbarBtn" type="button" data-mbar-atc>Add to cart</button>
    </div>
  </div>

  <script>
    (() => {
      const root = document.currentScript.closest('.pp');
      if (!root) return;

      // -------------------------
      // Helpers
      // -------------------------
      const moneyFormat = (cents) => {
        // Simple default; theme might override via Shopify.formatMoney if available
        if (window.Shopify && typeof window.Shopify.formatMoney === 'function') {
          try { return window.Shopify.formatMoney(cents); } catch (e) {}
        }
        return '$' + (cents / 100).toFixed(2);
      };

      const variants = {{ product.variants | json }};
      const optionNames = {{ product.options | json }};

      const form = root.querySelector('form');
      const idInput = root.querySelector('[data-variant-id]');
      const qtyInput = root.querySelector('[data-qty-input]');
      const hiddenQty = root.querySelector('[data-hidden-qty]');

      const priceNow = root.querySelector('[data-price-now]');
      const priceWas = root.querySelector('[data-price-was]');
      const priceBadge = root.querySelector('[data-price-badge]');
      const soldout = root.querySelector('[data-soldout]');
      const atcBtn = root.querySelector('[data-atc]');

      const stickyPrice = root.querySelector('[data-sticky-price]');
      const mbarPrice = root.querySelector('[data-mbar-price]');

      // -------------------------
      // Quantity sync
      // -------------------------
      const syncQty = () => {
        const q = Math.max(1, parseInt(qtyInput?.value || '1', 10));
        if (qtyInput) qtyInput.value = String(q);
        if (hiddenQty) hiddenQty.value = String(q);
      };

      root.querySelectorAll('[data-qty]').forEach(btn => {
        btn.addEventListener('click', () => {
          const dir = btn.getAttribute('data-qty');
          const current = parseInt(qtyInput.value || '1', 10);
          const next = dir === 'plus' ? current + 1 : Math.max(1, current - 1);
          qtyInput.value = String(next);
          syncQty();
        });
      });
      qtyInput?.addEventListener('change', syncQty);
      syncQty();

      // -------------------------
      // Variant selection
      // -------------------------
      const getSelectedOptions = () => {
        const selected = [];
        optionNames.forEach((name, idx) => {
          const fs = root.querySelector(`fieldset[data-option-index="${idx}"]`);
          const checked = fs?.querySelector('input[type="radio"]:checked');
          selected.push(checked ? checked.value : null);
        });
        return selected;
      };

      const findVariantByOptions = (optionsArr) => {
        return variants.find(v => v.options.every((opt, i) => opt === optionsArr[i]));
      };

      const updatePricesAndATC = (v) => {
        if (!v) return;

        if (idInput) idInput.value = v.id;
        if (priceNow) priceNow.textContent = moneyFormat(v.price);

        const hasCompare = v.compare_at_price && v.compare_at_price > v.price;
        if (priceWas) priceWas.textContent = hasCompare ? moneyFormat(v.compare_at_price) : '';
        if (priceBadge) priceBadge.style.display = hasCompare ? '' : 'none';
        if (soldout) soldout.style.display = v.available ? 'none' : '';

        if (atcBtn) {
          atcBtn.disabled = !v.available;
          atcBtn.textContent = v.available ? 'Add to cart' : 'Sold out';
        }

        if (stickyPrice) stickyPrice.textContent = moneyFormat(v.price);
        if (mbarPrice) mbarPrice.textContent = moneyFormat(v.price);
      };

      const setActiveMediaForVariant = (v) => {
        // If variant has featured_media in JSON, use it. Otherwise leave.
        if (!v || !v.featured_media) return;
        const mediaId = v.featured_media.id;
        galleryGoToMediaId(mediaId);
      };

      // -------------------------
      // Disable unavailable variant chips
      // Logic: for each option value, test if any variant exists with:
      // - that value at this option index
      // - other already-selected options fixed
      // - and variant is available
      // If not, disable that chip.
      // -------------------------
      const updateOptionAvailability = () => {
        const current = getSelectedOptions();

        optionNames.forEach((optName, optIndex) => {
          const fs = root.querySelector(`fieldset[data-option-index="${optIndex}"]`);
          if (!fs) return;

          const radios = [...fs.querySelectorAll('input.pp__radio')];

          radios.forEach(radio => {
            const value = radio.value;
            const testOptions = [...current];
            testOptions[optIndex] = value;

            const possible = variants.some(v => {
              const matches = v.options.every((opt, i) => {
                if (i === optIndex) return opt === value;
                // if a different option is selected, must match it; if null, allow any
                return testOptions[i] === null ? true : opt === testOptions[i];
              });
              return matches && v.available;
            });

            const label = fs.querySelector(`label[for="${radio.id}"]`);
            if (label) {
              label.classList.toggle('is-disabled', !possible);
            }
            radio.disabled = !possible;
          });
        });
      };

      const onOptionsChanged = () => {
        const selected = getSelectedOptions();
        const v = findVariantByOptions(selected) || variants.find(x => x.available) || variants[0];
        updateOptionAvailability();
        updatePricesAndATC(v);
        setActiveMediaForVariant(v);
      };

      root.querySelectorAll('input.pp__radio').forEach(i => i.addEventListener('change', onOptionsChanged));
      updateOptionAvailability();
      onOptionsChanged();

      // -------------------------
      // Sticky ATC triggers real add button
      // -------------------------
      const clickRealATC = () => root.querySelector('[data-atc]')?.click();
      root.querySelector('[data-sticky-atc]')?.addEventListener('click', clickRealATC);
      root.querySelector('[data-mbar-atc]')?.addEventListener('click', clickRealATC);

      // -------------------------
      // Swipe gallery (mobile) + arrows (desktop)
      // -------------------------
      const slider = root.querySelector('[data-slider]');
      const dotsWrap = root.querySelector('[data-dots]');
      const thumbs = [...root.querySelectorAll('[data-thumb]')];

      let currentIndex = 0;
      let slideCount = slider ? slider.children.length : 0;

      const setSliderIndex = (idx, opts = { smooth: true }) => {
        if (!slider || slideCount === 0) return;
        currentIndex = Math.max(0, Math.min(slideCount - 1, idx));
        slider.scrollTo({
          left: slider.clientWidth * currentIndex,
          behavior: opts.smooth ? 'smooth' : 'auto'
        });
        updateDots();
        updateThumbs();
      };

      const updateDots = () => {
        if (!dotsWrap) return;
        dotsWrap.querySelectorAll('button').forEach((b, i) => {
          b.classList.toggle('is-active', i === currentIndex);
        });
      };

      const updateThumbs = () => {
        thumbs.forEach((t, i) => t.classList.toggle('is-active', i === currentIndex));
      };

      const buildDots = () => {
        if (!dotsWrap || slideCount <= 1) return;
        dotsWrap.innerHTML = '';
        for (let i = 0; i < slideCount; i++) {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'pp__dot' + (i === 0 ? ' is-active' : '');
          b.setAttribute('aria-label', `Go to image ${i+1}`);
          b.addEventListener('click', () => setSliderIndex(i));
          dotsWrap.appendChild(b);
        }
      };

      const onScroll = () => {
        if (!slider) return;
        const idx = Math.round(slider.scrollLeft / slider.clientWidth);
        if (idx !== currentIndex) {
          currentIndex = idx;
          updateDots();
          updateThumbs();
        }
      };

      const galleryGoToMediaId = (mediaId) => {
        if (!slider) return;
        const slides = [...slider.querySelectorAll('.pp__slide')];
        const idx = slides.findIndex(s => String(s.getAttribute('data-media-id')) === String(mediaId));
        if (idx >= 0) setSliderIndex(idx);
      };

      buildDots();
      slider?.addEventListener('scroll', () => window.requestAnimationFrame(onScroll));

      root.querySelector('[data-prev]')?.addEventListener('click', () => setSliderIndex(currentIndex - 1));
      root.querySelector('[data-next]')?.addEventListener('click', () => setSliderIndex(currentIndex + 1));

      thumbs.forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.getAttribute('data-thumb'), 10);
          setSliderIndex(idx);
        });
      });

      // Swipe handling (touch)
      let touchStartX = 0, touchStartY = 0, isDragging = false;
      slider?.addEventListener('touchstart', (e) => {
        if (!e.touches || !e.touches[0]) return;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        isDragging = true;
      }, { passive: true });

      slider?.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        isDragging = false;
        const touch = e.changedTouches && e.changedTouches[0];
        if (!touch) return;
        const dx = touch.clientX - touchStartX;
        const dy = touch.clientY - touchStartY;
        if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy)) {
          setSliderIndex(currentIndex + (dx < 0 ? 1 : -1));
        }
      });

      // -------------------------
      // Zoom modal (click image)
      // -------------------------
      const zoom = root.querySelector('[data-zoom]');
      const zoomImg = root.querySelector('[data-zoom-img]');
      const zoomClose = root.querySelector('[data-zoom-close]');

      const openZoom = () => {
        if (!zoom || !zoomImg) return;
        const activeSlide = slider?.children?.[currentIndex];
        const img = activeSlide?.querySelector('img');
        if (!img) return;
        zoomImg.src = img.currentSrc || img.src;
        if (typeof zoom.showModal === 'function') zoom.showModal();
        else zoom.setAttribute('open', 'open');
      };

      root.querySelector('[data-main]')?.addEventListener('click', (e) => {
        // avoid when clicking nav buttons
        if (e.target.closest('.pp__nav') || e.target.closest('.pp__dot')) return;
        openZoom();
      });

      zoomClose?.addEventListener('click', () => zoom?.close?.());
      zoom?.addEventListener('click', (e) => {
        const rect = zoom.getBoundingClientRect();
        const inDialog = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inDialog) zoom.close?.();
      });

      // -------------------------
      // Recommendations (Upsells/Cross-sells)
      // -------------------------
      const recs = root.querySelector('[data-recs]');
      const recsGrid = root.querySelector('[data-recs-grid]');
      if (recs && recsGrid) {
        const url = recs.getAttribute('data-recs-url');
        fetch(url)
          .then(r => r.text())
          .then(html => {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            // Shopify returns a section of HTML; find product grid links
            const links = [...doc.querySelectorAll('a[href*="/products/"]')].slice(0, 8);
            if (!links.length) {
              recsGrid.innerHTML = '';
              return;
            }
            // Build lightweight cards from the returned HTML (best effort)
            const cards = links.map(a => {
              const card = a.closest('li, .grid__item, .card') || a;
              return card.outerHTML;
            });
            recsGrid.innerHTML = cards.join('');
            recsGrid.classList.add('pp__recsGrid--ready');
          })
          .catch(() => { recsGrid.innerHTML = ''; });
      }

      // -------------------------
      // Bundles (multi-add) + optional discount code apply
      // - Adds selected variants via /cart/add.js
      // - If a discount code provided, redirect to /checkout?discount=CODE
      // -------------------------
      const bundle = root.querySelector('[data-bundle]');
      const bundleBtn = root.querySelector('[data-bundle-add]');
      if (bundle && bundleBtn) {
        bundleBtn.addEventListener('click', async () => {
          const checked = [...bundle.querySelectorAll('input[type="checkbox"]:checked')];
          const items = checked
            .map(i => ({ id: parseInt(i.getAttribute('data-bundle-variant'), 10), quantity: 1 }))
            .filter(x => Number.isFinite(x.id));

          // Always include main selected variant too (common bundle UX)
          const mainVariantId = parseInt(idInput?.value || '0', 10);
          if (Number.isFinite(mainVariantId) && mainVariantId > 0) {
            items.unshift({ id: mainVariantId, quantity: Math.max(1, parseInt(qtyInput?.value || '1', 10)) });
          }

          if (!items.length) return;

          bundleBtn.disabled = true;
          bundleBtn.textContent = 'Adding…';

          try {
            const res = await fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ items })
            });
            if (!res.ok) throw new Error('Failed to add bundle');

            const code = {{ section.settings.bundle_discount_code | json }};
            if (code) {
              window.location.href = `/checkout?discount=${encodeURIComponent(code)}`;
            } else {
              window.location.href = '/cart';
            }
          } catch (e) {
            bundleBtn.disabled = false;
            bundleBtn.textContent = 'Add selected bundle';
            alert('Sorry — could not add bundle. Please try again.');
          }
        });
      }

      // -------------------------
      // Klaviyo hooks
      // Works if Klaviyo is installed (window._learnq exists)
      // -------------------------
      const track = (eventName, payload) => {
        if (!window._learnq || !Array.isArray(window._learnq)) return;
        window._learnq.push(['track', eventName, payload]);
      };

      // Viewed Product
      track('Viewed Product', {
        ProductID: root.getAttribute('data-product-id'),
        ProductName: root.getAttribute('data-product-title'),
        ProductURL: root.getAttribute('data-product-url')
      });

      // Added to Cart (hook into submit)
      form?.addEventListener('submit', () => {
        const vid = parseInt(idInput?.value || '0', 10);
        const q = Math.max(1, parseInt(qtyInput?.value || '1', 10));
        const variant = variants.find(x => x.id === vid);

        track('Added to Cart', {
          ProductID: root.getAttribute('data-product-id'),
          ProductName: root.getAttribute('data-product-title'),
          VariantID: vid,
          VariantName: variant ? variant.title : '',
          Quantity: q,
          Price: variant ? variant.price : null,
          ProductURL: root.getAttribute('data-product-url')
        });
      });

      // Started Checkout: track when user clicks any checkout button
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('button[name="checkout"], a[href*="/checkout"]');
        if (!btn) return;
        track('Started Checkout', {
          ProductID: root.getAttribute('data-product-id'),
          ProductName: root.getAttribute('data-product-title')
        });
      });
    })();
  </script>

  {% schema %}
  {
    "name": "Main product (Pro+)",
    "settings": [
      { "type": "checkbox", "id": "show_vendor", "label": "Show vendor", "default": true },
      { "type": "checkbox", "id": "show_short", "label": "Show short description", "default": true },
      { "type": "checkbox", "id": "show_trust", "label": "Show trust bullets", "default": true },
      { "type": "checkbox", "id": "show_rating", "label": "Show rating mock", "default": true },
      { "type": "money", "id": "free_ship_threshold", "label": "Free shipping threshold", "default": 5000 },

      { "type": "header", "content": "Upsells / Recommendations" },
      { "type": "checkbox", "id": "enable_recs", "label": "Enable recommendations", "default": true },
      { "type": "text", "id": "recs_title", "label": "Recommendations title", "default": "You may also like" },
      { "type": "range", "id": "recs_limit", "label": "Max items", "min": 2, "max": 12, "step": 1, "default": 6 },

      { "type": "header", "content": "Bundles / Buy X Get Y (UI + multi-add)" },
      { "type": "checkbox", "id": "enable_bundles", "label": "Enable bundle box", "default": false },
      { "type": "text", "id": "bundle_title", "label": "Bundle title", "default": "Bundle & save" },
      { "type": "text", "id": "bundle_hint", "label": "Bundle hint", "default": "Add extras for a better deal." },
      { "type": "product", "id": "bundle_product_1", "label": "Bundle product 1" },
      { "type": "product", "id": "bundle_product_2", "label": "Bundle product 2" },
      { "type": "product", "id": "bundle_product_3", "label": "Bundle product 3" },
      { "type": "text", "id": "bundle_discount_code", "label": "Optional discount code (applied at checkout)", "default": "" }
    ]
  }
  {% endschema %}
</section>
